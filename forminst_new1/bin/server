#!/usr/bin/env ruby
ENV['RAILS_ENV'] = ARGV.first || ENV['RAILS_ENV'] || 'development'
require File.expand_path(File.dirname(__FILE__) + "/../config/environment")

# Change the following to reflect your database settings
ActiveRecord::Base.establish_connection(
  adapter:  'mysql2', # or 'postgresql' or 'sqlite3' or 'oracle_enhanced'
  host:     'localhost',
  database: 'FORMIST',
  username: 'root',
  password: '2552'
)

while true

	#Aclualizar los estatus de las adecuaciones luego de haber pasado dos semana-----------------------------------------------
	estatus_adecuacion = EstatusAdecuacion.where(actual: 1).all
	fecha = Time.now.strftime("%Y-%m-%d")
	fecha2 = Time.now
	estatus_adecuacion.each do |status|
		if status.fecha + 2.week <= fecha2
			puts status.fecha
			#----------------------------------------------
			if status.estatus_id == 3
				status.actual = 0
				status.save
				nuevoEstatus = EstatusAdecuacion.new
				nuevoEstatus.adecuacion_id = status.adecuacion_id
				nuevoEstatus.fecha = fecha
				nuevoEstatus.estatus_id = 8
				nuevoEstatus.actual = 1
				nuevoEstatus.save
				adecuacion = Adecuacion.where(id: status.adecuacion_id).take
				plan= Planformacion.find(adecuacion.planformacion_id)
				notific = Notificacion.new
		        notific.instructor_id = plan.instructor_id
		        notific.tutor_id = plan.tutor_id
		        notific.adecuacion_id = status.adecuacion_id
		        notific.informe_id = nil
		        notific.actual = 1
		        person = Persona.where(usuario_id: plan.instructor_id).take
		        notificacionfecha = Date.current.to_s 
	        	notific.mensaje = "[" + notificacionfecha + "] La adecuación de "+ person.nombres.to_s.split.map(&:capitalize).join(' ') + " " + person.apellidos.to_s.split.map(&:capitalize).join(' ') + " ha sido aprobada por Comisión de Investigación y fue enviada a Consejo de Escuela."
	        	notific.save
	        	notific2 = Notificacion.new
		        notific2.instructor_id = plan.instructor_id
		        notific2.tutor_id = plan.tutor_id
		        notific2.adecuacion_id = status.adecuacion_id
		        notific2.informe_id = nil
		        notific2.actual = 2
	        	notific2.mensaje = "[" + notificacionfecha + "] Su adecuación ha sido aprobada por Comisión de Investigación y fue enviada a Consejo de Escuela"
	        	notific2.save
	        	notific3 = Notificacion.new
		        notific3.instructor_id = plan.instructor_id
		        notific3.tutor_id = plan.tutor_id
		        notific3.adecuacion_id = status.adecuacion_id
		        notific3.informe_id = nil
		        notific3.actual = 4		#Consejo de Escuela
	        	notific3.mensaje = "[" + notificacionfecha + "] Se ha recibido una nueva Adecuación: "+ person.nombres.to_s.split.map(&:capitalize).join(' ') + " " + person.apellidos.to_s.split.map(&:capitalize).join(' ') + ", favor aprobar y enviar a la siguiente entidad."
	        	notific3.save

				 user =Usuarioentidad.where(usuario_id: plan.tutor_id).take
		          if(user.escuela_id == 1)
		            uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 1).take
		          else
		            if(user.escuela_id == 2)
		              uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 2).take
		            else
		              if(user.escuela_id == 3)
		                uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 3).take
		              else
		                if(user.escuela_id == 4)
		                uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 4).take
		                else
		                  if(user.escuela_id == 9)
		                    uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 5).take
		                  else
		                    if(user.escuela_id == 10)
		                      uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 6).take
		                    end
		                  end
		                end
		              end
		            end  
		          end
				remitente3 = Usuario.where(id: plan.tutor_id).take
				ActionCorreo.envio_adecuacion(remitente3, notific.mensaje,2).deliver
				remitente2 = Usuario.where(id: plan.instructor_id).take
				ActionCorreo.envio_adecuacion(remitente2, notific2.mensaje,1).deliver
				remitente = Usuario.where(id: uentidad.usuario_id).take
				ActionCorreo.envio_adecuacion(remitente, notific3.mensaje,0).deliver
			elsif status.estatus_id == 8
				status.actual = 0
				status.save
				nuevoEstatus = EstatusAdecuacion.new
				nuevoEstatus.adecuacion_id = status.adecuacion_id
				nuevoEstatus.fecha = fecha
				nuevoEstatus.estatus_id = 4
				nuevoEstatus.actual = 1
				nuevoEstatus.save
				adecuacion = Adecuacion.where(id: status.adecuacion_id).take
				plan= Planformacion.find(adecuacion.planformacion_id)
				notific = Notificacion.new
		        notific.instructor_id = plan.instructor_id
		        notific.tutor_id = plan.tutor_id
		        notific.adecuacion_id = status.adecuacion_id
		        notific.informe_id = nil
		        notific.actual = 1
		        person = Persona.where(usuario_id: plan.instructor_id).take
		        notificacionfecha = Date.current.to_s 
	        	notific.mensaje = "[" + notificacionfecha + "] La adecuación de "+ person.nombres.to_s.split.map(&:capitalize).join(' ') + " " + person.apellidos.to_s.split.map(&:capitalize).join(' ') + " ha sido aprobada por Consejo de Escuela y fue enviada a Consejo de Facultad."
	        	notific.save
	        	notific2 = Notificacion.new
		        notific2.instructor_id = plan.instructor_id
		        notific2.tutor_id = plan.tutor_id
		        notific2.adecuacion_id = status.adecuacion_id
		        notific2.informe_id = nil
		        notific2.actual = 2
	        	notific2.mensaje = "[" + notificacionfecha + "] Su adecuación ha sido aprobada por Consejo de Escuela y fue enviada a Consejo de Facultad"
	        	notific2.save
	        	notific3 = Notificacion.new
		        notific3.instructor_id = plan.instructor_id
		        notific3.tutor_id = plan.tutor_id
		        notific3.adecuacion_id = status.adecuacion_id
		        notific3.informe_id = nil
		        notific3.actual = 5		#Consejo de Escuela
	        	notific3.mensaje = "[" + notificacionfecha + "] Se ha recibido una nueva Adecuación: "+ person.nombres.to_s.split.map(&:capitalize).join(' ') + " " + person.apellidos.to_s.split.map(&:capitalize).join(' ') + ", Revisar."
	        	notific3.save
	       		uentidad = Usuarioentidad.where(entidad_id: 13).take
				remitente3 = Usuario.where(id: plan.tutor_id).take
				ActionCorreo.envio_adecuacion(remitente3, notific.mensaje,2).deliver
				remitente2 = Usuario.where(id: plan.instructor_id).take
				ActionCorreo.envio_adecuacion(remitente2, notific2.mensaje,1).deliver
				remitente = Usuario.where(id: uentidad.usuario_id).take
				ActionCorreo.envio_adecuacion(remitente, notific3.mensaje,0).deliver
			end
			#-------------------------------------------------
		end

	end
	#FIN clualizar los estatus de las adecuaciones luego de haber pasado dos semana---------------------------------------------
	
	#Aclualizar los estatus de los informes luego de haber pasado dos semana-----------------------------------------------
	estatus_informes = EstatusInforme.where(actual: 1).all
	fecha = Time.now.strftime("%Y-%m-%d")
	fecha2 = Time.now
	estatus_informes.each do |status|
		if status.fecha + 2.week <= fecha2
			puts status.fecha
			#----------------------------------------------
			if status.estatus_id == 3
				status.actual = 0
				status.save
				nuevoEstatus = EstatusInforme.new
				nuevoEstatus.informe_id = status.informe_id
				nuevoEstatus.fecha = fecha
				nuevoEstatus.estatus_id = 8
				nuevoEstatus.actual = 1
				nuevoEstatus.save
				informe = Informe.where(id: status.informe_id).take
				if (informe.numero == 1 || informe.numero == 3)
		        	nombre_informe= "PRIMER INFORME "
		      	elsif (informe.numero == 2 || informe.numero == 6)
		         	nombre_informe= "SEGUNDO INFORME "
		        elsif informe.numero == 4
	            	nombre_informe= "TERCER INFORME "
				elsif informe.numero == 5
	            	nombre_informe= "CUARTO INFORME "
		      	end

		      	if informe.tipo_id == 1
		        	nombre_informe = nombre_informe+"SEMESTRAL"
		      	else
		        	if informe.tipo_id == 2
		          		nombre_informe = nombre_informe+"ANUAL"
		        	else
		          		nombre_informe = nombre_informe+"FINAL"
		        	end
		      	end
				plan = Planformacion.find(informe.planformacion_id)
				adecuacion = Adecuacion.where(planformacion_id: plan.id).take 
				notific = Notificacion.new
				notific.instructor_id = plan.instructor_id
				notific.tutor_id = informe.tutor_id
				notific.adecuacion_id = adecuacion.id
				notific.informe_id = informe.id
				notific.actual = 1
				person = Persona.where(usuario_id: plan.instructor_id).take
				notificacionfecha = Date.current.to_s 
				notific.mensaje = "[" + notificacionfecha + "] El " + nombre_informe + " de " + person.nombres.to_s.split.map(&:capitalize).join(' ') + " " + person.apellidos.to_s.split.map(&:capitalize).join(' ') + " ha sido aprobado por Comisión de Investigación y fue enviada a Consejo de Escuela."
				notific.save
				notific2 = Notificacion.new
				notific2.instructor_id = plan.instructor_id
				notific2.tutor_id = informe.tutor_id
				notific2.adecuacion_id = adecuacion.id
				notific2.informe_id = informe.id
				notific2.actual = 2
				notific2.mensaje = "[" + notificacionfecha + "] El " + nombre_informe + " ha sido aprobado por Comisión de Investigación y fue enviada a Consejo de Escuela."
				notific2.save
				notific3 = Notificacion.new
				notific3.instructor_id = plan.instructor_id
				notific3.tutor_id = informe.tutor_id
				notific3.adecuacion_id = adecuacion.id
				notific3.informe_id = informe.id
				notific3.actual = 4   #Consejo de Escuela
				notific3.mensaje = "[" + notificacionfecha + "] Ha recibido un nuevo Informe: ' " + nombre_informe + " ' de " + person.nombres.to_s.split.map(&:capitalize).join(' ') + " " + person.apellidos.to_s.split.map(&:capitalize).join(' ') + ", favor aprobar y enviar a la siguiente entidad."
				notific3.save
		          user =Usuarioentidad.where(usuario_id: plan.tutor_id).take
		          if(user.escuela_id == 1)
		            uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 1).take
		          else
		            if(user.escuela_id == 2)
		              uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 2).take
		            else
		              if(user.escuela_id == 3)
		                uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 3).take
		              else
		                if(user.escuela_id == 4)
		                uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 4).take
		                else
		                  if(user.escuela_id == 9)
		                    uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 5).take
		                  else
		                    if(user.escuela_id == 10)
		                      uentidad = Usuarioentidad.where(escuela_id: user.escuela_id, entidad_id: 6).take
		                    end
		                  end
		                end
		              end
		            end  
		          end
		          remitente3 = Usuario.where(id: informe.tutor_id).take
			      ActionCorreo.envio_informe(remitente3, notific.mensaje,2).deliver
			      remitente2 = Usuario.where(id: plan.instructor_id).take
			      ActionCorreo.envio_informe(remitente2, notific2.mensaje,1).deliver
			      remitente = Usuario.where(id: uentidad.usuario_id).take
			      ActionCorreo.envio_informe(remitente, notific3.mensaje,0).deliver
			elsif status.estatus_id == 8
				status.actual = 0
				status.save
				nuevoEstatus = EstatusInforme.new
				nuevoEstatus.informe_id = status.informe_id
				nuevoEstatus.fecha = fecha
				nuevoEstatus.estatus_id = 4
				nuevoEstatus.actual = 1
				nuevoEstatus.save
				informe = Informe.where(id: status.informe_id).take
				if (informe.numero == 1 || informe.numero == 3)
		        	nombre_informe= "PRIMER INFORME "
		      	elsif (informe.numero == 2 || informe.numero == 6)
		         	nombre_informe= "SEGUNDO INFORME "
		        elsif informe.numero == 4
	            	nombre_informe= "TERCER INFORME "
				elsif informe.numero == 5
	            	nombre_informe= "CUARTO INFORME "
		      	end

		      	if informe.tipo_id == 1
		        	nombre_informe = nombre_informe+"SEMESTRAL"
		      	else
		        	if informe.tipo_id == 2
		          		nombre_informe = nombre_informe+"ANUAL"
		        	else
		          		nombre_informe = nombre_informe+"FINAL"
		        	end
		      	end
				plan = Planformacion.find(informe.planformacion_id)
				adecuacion = Adecuacion.where(planformacion_id: plan.id).take
				notific = Notificacion.new
				notific.instructor_id = plan.instructor_id
				notific.tutor_id = informe.tutor_id
				notific.adecuacion_id = adecuacion.id
				notific.informe_id = informe.id
				notific.actual = 1
				person = Persona.where(usuario_id: plan.instructor_id).take
				notificacionfecha = Date.current.to_s 
				notific.mensaje = "[" + notificacionfecha + "] El " + nombre_informe + " de " + person.nombres.to_s.split.map(&:capitalize).join(' ') + " " + person.apellidos.to_s.split.map(&:capitalize).join(' ') + " ha sido aprobado por Consejo de Escuela y fue enviada a Consejo de Facultad."
				notific.save
				notific2 = Notificacion.new
				notific2.instructor_id = plan.instructor_id
				notific2.tutor_id = informe.tutor_id
				notific2.adecuacion_id = adecuacion.id
				notific2.informe_id = informe.id
				notific2.actual = 2
				notific2.mensaje = "[" + notificacionfecha + "] El " + nombre_informe + " ha sido aprobado por Consejo de Escuela y fue enviada a Consejo de Facultad."
				notific2.save
				notific3 = Notificacion.new
				notific3.instructor_id = plan.instructor_id
				notific3.tutor_id = informe.tutor_id
				notific3.adecuacion_id = adecuacion.id
				notific3.informe_id = informe.id
				notific3.actual = 5   #Consejo de Facultad
				notific3.mensaje = "[" + notificacionfecha + "] Ha recibido un nuevo Informe: ' " + nombre_informe + " ' de " + person.nombres.to_s.split.map(&:capitalize).join(' ') + " " + person.apellidos.to_s.split.map(&:capitalize).join(' ') + ", revisar."
				notific3.save

				uentidad = Usuarioentidad.where(entidad_id: 13).take
				remitente3 = Usuario.where(id: informe.tutor_id).take
				ActionCorreo.envio_informe(remitente3, notific.mensaje,2).deliver
				remitente2 = Usuario.where(id: plan.instructor_id).take
				ActionCorreo.envio_informe(remitente2, notific2.mensaje,1).deliver
				remitente = Usuario.where(id: uentidad.usuario_id).take
				ActionCorreo.envio_informe(remitente, notific3.mensaje,0).deliver
			end
			#-------------------------------------------------
		end

	end
	#FIN aclualizar los estatus de los informes luego de haber pasado dos semana--------------------------------------------
	sleep(1.day)
end